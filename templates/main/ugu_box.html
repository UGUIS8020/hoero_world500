{% extends "common/base.html" %} {% block title %}ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡{% endblock %} {%
block content %}


<style>
    .drop-zone {
        border: 2px dashed #ccc;
        padding: 20px;
        text-align: center;
        margin: 20px auto;
        background-color: #f8f9fa;
        border-radius: 4px;
        max-width: 800px;
    }
    .drop-zone.active {
        border-color: #007bff;
        background-color: #e8f4ff;
    }
    .file-list {
        margin-top: 20px;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }
    .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background-color: #f8f9fa;
        margin-bottom: 5px;
        border-radius: 4px;
    }
    .folder-item {
        background-color: #e8f4ff;
        font-weight: bold;
    }
    .file-path {
        color: #666;
        font-size: 0.8em;
        display: block;
        word-break: break-all;
    }
    .file-remove {
        color: red;
        cursor: pointer;
        padding: 0 10px;
    }
    #status {
        margin-top: 20px;
        padding: 10px;
        border-radius: 4px;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }
    .processing {
        background-color: #e2e3e5;
        color: #383d41;
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% {
            opacity: 0.6;
        }
        50% {
            opacity: 1;
        }
        100% {
            opacity: 0.6;
        }
    }
    .error {
        background-color: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
    }
    .success {
        background-color: #d4edda;
        color: #155724;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
    }
    .info {
        background-color: #d1ecf1;
        color: #0c5460;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
    }
    .progress-container {
        width: 100%;
        background-color: #f1f1f1;
        border-radius: 4px;
        margin-top: 10px;
    }
    .progress-bar {
        height: 20px;
        background-color: #4caf50;
        border-radius: 4px;
        width: 0%;
        transition: width 0.3s;
        text-align: center;
        line-height: 20px;
        color: white;
    }
    .button-group {
        margin-top: 15px;
    }
    button {
        padding: 8px 16px;
        margin: 0 5px;
        border: none;
        border-radius: 4px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
    }
    button:hover {
        background-color: #0069d9;
    }
    button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }
</style>


<h2 style="text-align: center;">UGU_Boxãƒ‡ãƒ¼ã‚¿é€ä¿¡</h2>
<div class="drop-zone" id="dropZone">
    <p>
        ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„
    </p>
    <p style="font-size: 0.9em; color: #666">
        æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: 2GB<br />
        å¯¾å¿œãƒ•ã‚¡ã‚¤ãƒ«: ã™ã¹ã¦<br />
        å‡¦ç†: ZIPåœ§ç¸®å¾Œã€S3ã¸è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    </p>
    <div class="button-group">
        <input
            type="file"
            id="fileInput"
            name="files[]"
            multiple
            style="display: none"
        />
        <input
            type="file"
            id="folderInput"
            name="folders[]"
            multiple
            webkitdirectory
            directory
            style="display: none"
        />
        <button onclick="document.getElementById('fileInput').click()">
            ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
        </button>
        <button onclick="document.getElementById('folderInput').click()">
            ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ
        </button>
        <button id="uploadButton" disabled>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        <button id="clearButton" disabled>ã‚¯ãƒªã‚¢</button>
    </div>
</div>

<div id="status"></div>
<div id="progressContainer" class="progress-container" style="display: none">
    <div id="progressBar" class="progress-bar">0%</div>
</div>
<div id="fileList" class="file-list"></div>

<hr style="margin: 40px auto; max-width: 800px" />

<h2 style="text-align: center">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h2>
<div id="uploadedFilesList" style="max-width: 700px; margin: 0 auto">
    <p style="text-align: center">èª­ã¿è¾¼ã¿ä¸­...</p>
</div>
               
</div>

<script>
const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");
const folderInput = document.getElementById("folderInput");
const fileList = document.getElementById("fileList");
const status = document.getElementById("status");
const uploadButton = document.getElementById("uploadButton");
const clearButton = document.getElementById("clearButton");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");

let selectedFiles = []; // é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒ
let totalSize = 0;

// 100ä»¶ä»¥ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«å¿…è¦ãªé–¢æ•°
async function readAllEntries(reader) {
    const entries = [];

    async function readBatch() {
        return new Promise((resolve, reject) => {
            reader.readEntries((batch) => {
                if (batch.length === 0) {
                    resolve(null); // çµ‚äº†æ¡ä»¶
                } else {
                    resolve(batch);
                }
            }, reject);
        });
    }

    let batch;
    while ((batch = await readBatch()) !== null) {
        entries.push(...batch);
    }

    return entries;
}

function showStatus(message, type) {
    status.innerHTML = `<div class="${type}">${message}</div>`;
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + " B";
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
    if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + " MB";
    return (bytes / (1024 * 1024 * 1024)).toFixed(1) + " GB";
}

function updateButtonState() {
    uploadButton.disabled = selectedFiles.length === 0;
    clearButton.disabled = selectedFiles.length === 0;
}

function getRelativePath(file) {
    // webkitRelativePathãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
    if (file.webkitRelativePath) return file.webkitRelativePath;

    // DataTransferItemã§ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®å ´åˆ
    if (file.relativePath) return file.relativePath;

    // é€šå¸¸ã®ãƒ•ã‚¡ã‚¤ãƒ«
    return file.name;
}

function displayFiles() {
    fileList.innerHTML = "";
    totalSize = 0;

    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const filesByFolder = {};

    selectedFiles.forEach((file) => {
        totalSize += file.size;
        const path = getRelativePath(file);
        const folderPath = path.includes("/")
            ? path.substring(0, path.lastIndexOf("/"))
            : "";

        if (!filesByFolder[folderPath]) {
            filesByFolder[folderPath] = [];
        }
        filesByFolder[folderPath].push(file);
    });

    // ãƒ•ã‚©ãƒ«ãƒ€ã”ã¨ã«è¡¨ç¤º
    Object.keys(filesByFolder)
        .sort()
        .forEach((folder) => {
            if (folder !== "") {
                // ãƒ•ã‚©ãƒ«ãƒ€è¦‹å‡ºã—
                const folderItem = document.createElement("div");
                folderItem.className = "file-item folder-item";
                folderItem.innerHTML = `<span>ğŸ“ ${folder}/</span>`;
                fileList.appendChild(folderItem);
            }

            // ãã®ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«
            filesByFolder[folder].forEach((file) => {
                const path = getRelativePath(file);
                const fileName = path.includes("/")
                    ? path.substring(path.lastIndexOf("/") + 1)
                    : path;

                const item = document.createElement("div");
                item.className = "file-item";
                item.innerHTML = `
                <div>
                    <span>${fileName}</span>
                    <span class="file-size">(${formatFileSize(
                        file.size
                    )})</span>
                </div>
                <span class="file-remove" data-path="${path}">âŒ</span>
            `;
                fileList.appendChild(item);

                // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                item.querySelector(".file-remove").addEventListener(
                    "click",
                    function () {
                        const pathToRemove = this.getAttribute("data-path");
                        selectedFiles = selectedFiles.filter(
                            (f) => getRelativePath(f) !== pathToRemove
                        );
                        displayFiles();
                        updateButtonState();

                        if (selectedFiles.length === 0) {
                            showStatus(
                                "ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚",
                                "info"
                            );
                        }
                    }
                );
            });
        });

    if (selectedFiles.length > 0) {
        showStatus(
            `${
                selectedFiles.length
            }ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ¸ˆã¿ (åˆè¨ˆ: ${formatFileSize(totalSize)})`,
            "info"
        );
    }
}

// ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ å‡¦ç†
function addFiles(files) {
    // ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
    const oversizedFiles = Array.from(files).filter(
        (f) => f.size > 2 * 1024 * 1024 * 1024
    );
    if (oversizedFiles.length > 0) {
        showStatus(
            `è­¦å‘Š: æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯2GBã‚’è¶…ãˆã‚‹ãŸã‚ç„¡è¦–ã•ã‚Œã¾ã—ãŸ: ${oversizedFiles
                .map((f) => f.name)
                .join(", ")}`,
            "error"
        );
    }

    // æœ‰åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã‚’è¿½åŠ 
    const validFiles = Array.from(files).filter(
        (f) => f.size <= 2 * 1024 * 1024 * 1024
    );

    // é‡è¤‡ãƒã‚§ãƒƒã‚¯
    for (const file of validFiles) {
        const path = getRelativePath(file);
        const duplicate = selectedFiles.find(
            (f) => getRelativePath(f) === path
        );

        if (!duplicate) {
            selectedFiles.push(file);
        }
    }

    displayFiles();
    updateButtonState();
}

// FileEntryã‹ã‚‰Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getFileFromEntry(fileEntry) {
    return new Promise((resolve) => {
        fileEntry.file(
            (file) => resolve(file),
            (error) => {
                console.error("ãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                resolve(null);
            }
        );
    });
}

// ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†å¸°çš„ã«èª­ã¿è¾¼ã‚€é–¢æ•°
async function readDirectory(directoryEntry) {
    const files = [];
    const dirReader = directoryEntry.createReader();
    const entries = await readAllEntries(dirReader);
    
    for (const entry of entries) {
        if (entry.isDirectory) {
            // ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å ´åˆã€å†å¸°çš„ã«èª­ã¿è¾¼ã‚€
            const subFiles = await readDirectory(entry);
            files.push(...subFiles);
        } else {
            // ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã€Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ã¦è¿½åŠ 
            const file = await getFileFromEntry(entry);
            if (file) {
                file.relativePath = entry.fullPath.substring(1); // å…ˆé ­ã® '/' ã‚’é™¤ã
                files.push(file);
            }
        }
    }
    
    return files;
}

// DataTransferItemListã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
async function handleDroppedItems(items) {
    const allFiles = [];
    
    for (let i = 0; i < items.length; i++) {
        const item = items[i];
        
        if (item.kind === "file") {
            const entry = item.webkitGetAsEntry();
            if (entry) {
                if (entry.isDirectory) {
                    // ãƒ•ã‚©ãƒ«ãƒ€ã®å ´åˆã€å†å¸°çš„ã«å‡¦ç†
                    const files = await readDirectory(entry);
                    allFiles.push(...files);
                } else {
                    // ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã€ãã®ã¾ã¾è¿½åŠ 
                    const file = item.getAsFile();
                    if (file) allFiles.push(file);
                }
            }
        }
    }
    
    // å–å¾—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’addFilesã«æ¸¡ã™
    if (allFiles.length > 0) {
        addFiles(allFiles);
        showStatus(`${allFiles.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚`, "success");
    }
}

// è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
function handleFiles(files) {
    // nullã‚’é™¤å¤–
    const validFiles = files.filter(file => file !== null);
    
    if (validFiles.length > 0) {
        addFiles(validFiles);
        showStatus(`${validFiles.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚`, "success");
    }
}

async function uploadFiles(files) {
    if (files.length === 0) return;

    const formData = new FormData();
    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿½åŠ ï¼ˆã“ã®è¡Œã‚’è¿½åŠ ï¼‰
    formData.append("csrf_token", csrf_token);    

    let totalBytes = files.reduce((sum, file) => sum + file.size, 0);
    let uploadedBytes = 0;

    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ä¿æŒã™ã‚‹ãŸã‚ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
    const paths = {};

    for (const file of files) {
        const path = getRelativePath(file);
        formData.append("files[]", file);
        // ãƒ‘ã‚¹æƒ…å ±ã‚’åˆ¥é€”é€ä¿¡
        paths[file.name] = path;
    }

    // ãƒ‘ã‚¹æƒ…å ±ã‚’JSONã¨ã—ã¦è¿½åŠ 
    formData.append("paths", JSON.stringify(paths));

    progressContainer.style.display = "block";
    showStatus("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...", "processing");
    uploadButton.disabled = true;
    clearButton.disabled = true;

    try {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", '/ugu_box/upload', true);

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹å‡¦ç†
        xhr.upload.onprogress = function (event) {
            if (event.lengthComputable) {
                uploadedBytes = event.loaded;
                const percentage = Math.round(
                    (uploadedBytes / totalBytes) * 100
                );
                progressBar.style.width = percentage + "%";
                progressBar.textContent = percentage + "%";
            }
        };

        xhr.onload = function () {
            if (xhr.status === 200) {
                const result = JSON.parse(xhr.responseText);
                showStatus(result.message || "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ", "success");
                fileList.innerHTML = "";
                selectedFiles = [];
                updateButtonState();
                progressContainer.style.display = "none";
                
                // é€šå¸¸ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®ã¿æ›´æ–°
                if (result.all_files && Array.isArray(result.all_files)) {
                    const filesList = document.getElementById("uploadedFilesList");
                    if (filesList) {
                        filesList.innerHTML = "";
                        result.all_files.forEach(fileInfo => {
                            const item = document.createElement("div");
                            item.className = "file-item";
                            item.innerHTML = `
                                <div>
                                    <span class="file-name">${fileInfo.name}</span>
                                    <span class="file-size">(${formatFileSize(fileInfo.size)})</span>
                                    <span class="file-date">${fileInfo.date}</span>
                                </div>
                                <div class="file-actions">
                                    <button class="download-btn" data-file="${fileInfo.name}">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                                    <button class="delete-btn" data-file="${fileInfo.name}">å‰Šé™¤</button>
                                </div>
                            `;
                            filesList.appendChild(item);
                        });
                        
                        // å‰Šé™¤ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                        document.querySelectorAll('.delete-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const fileName = this.getAttribute('data-file');
                                deleteFile(fileName);
                            });
                        });
                    }
                }
            } else {
                throw new Error(
                    xhr.statusText || "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
                );
            }
        };

        xhr.onerror = function () {
            showStatus("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", "error");
            progressContainer.style.display = "none";
        };

        xhr.send(formData);
    } catch (error) {
        showStatus("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", "error");
        console.error(error);
    } finally {
        uploadButton.disabled = false;
        clearButton.disabled = false;
    }
}

// ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
function downloadFile(fileName) {
    // ã‚µãƒ¼ãƒãƒ¼å´ã®/ugu_box/download/ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨
    const downloadUrl = `/ugu_box/download/${fileName}`;
    
    // ç”»é¢é·ç§»ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    window.location.href = downloadUrl;
    
    showStatus(`ã€Œ${fileName}ã€ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™...`, 'info');
}

// ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤æ©Ÿèƒ½
function deleteFile(fileName) {
    if (!confirm(`ã€Œ${fileName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
        return;
    }
    
    const xhr = new XMLHttpRequest();
    xhr.open("POST", "/ugu_box/delete", true);
    xhr.setRequestHeader("Content-Type", "application/json");
     // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¿½åŠ 
    xhr.setRequestHeader("X-CSRFToken", csrf_token);
    
    xhr.onload = function() {
        if (xhr.status === 200) {
            const result = JSON.parse(xhr.responseText);
            if (result.success) {
                showStatus(`ã€Œ${fileName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, "success");
                // é–¢é€£ã™ã‚‹è¦ç´ ã‚’DOMã‹ã‚‰å‰Šé™¤
                const fileElem = document.querySelector(`[data-file="${fileName}"]`).closest('.file-item');
                if (fileElem) {
                    fileElem.remove();
                }
            } else {
                showStatus(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${result.message || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"}`, "error");
            }
        } else {
            showStatus("å‰Šé™¤å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", "error");
        }
    };
    
    xhr.onerror = function() {
        showStatus("ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", "error");
    };
    
    xhr.send(JSON.stringify({ filename: fileName }));
}

// ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("active");
});

dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("active");
});

dropZone.addEventListener("drop", async (e) => {
    e.preventDefault();
    dropZone.classList.remove("active");

    if (e.dataTransfer.items) {
        // DataTransferItemListã‚’ä½¿ç”¨ï¼ˆãƒ•ã‚©ãƒ«ãƒ€ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸¡æ–¹ã‚’ã‚µãƒãƒ¼ãƒˆï¼‰
        await handleDroppedItems(e.dataTransfer.items);
    } else {
        // å¾“æ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ï¼ˆãƒ•ã‚©ãƒ«ãƒ€éã‚µãƒãƒ¼ãƒˆï¼‰
        handleFiles(Array.from(e.dataTransfer.files));
    }
});

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
fileInput.addEventListener("change", (e) => {
    handleFiles(Array.from(e.target.files));
});

// ãƒ•ã‚©ãƒ«ãƒ€é¸æŠå‡¦ç†
folderInput.addEventListener("change", (e) => {
    handleFiles(Array.from(e.target.files));
});

// ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚
uploadButton.addEventListener("click", () => {
    if (selectedFiles.length > 0) {
        uploadFiles(selectedFiles);
    }
});

// ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚
clearButton.addEventListener("click", () => {
    selectedFiles = [];
    fileList.innerHTML = "";
    showStatus("ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚", "info");
    updateButtonState();
});

function fetchFilesList() {
    fetch("/ugu_box/files")
        .then(response => response.json())
        .then(data => {
            updateFilesListUI(data);
        })
        .catch(error => {
            console.error("ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
            const filesList = document.getElementById("uploadedFilesList");
            if (filesList) {
                filesList.innerHTML = "<p>ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
            }
        });
}

// âœ… è¿½åŠ ï¼šãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å‘¼ã³å‡ºã™
document.addEventListener("DOMContentLoaded", () => {
    fetchFilesList();
});

    // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§UIã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateFilesListUI(files) {
    const filesList = document.getElementById("uploadedFilesList");
    if (!filesList) return;

    filesList.innerHTML = "";

    if (files.length === 0) {
        filesList.innerHTML = "<p style='text-align: center;'>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        return;
    }

    files.forEach(fileInfo => {
        const item = document.createElement("div");
        item.className = "file-item";

        // ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã§ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ±ºå®šï¼ˆä»»æ„ï¼‰
        let fileIcon = "ğŸ“„";
        const ext = fileInfo.filename.split(".").pop().toLowerCase();
        if (["jpg", "jpeg", "png", "gif"].includes(ext)) fileIcon = "ğŸ–¼ï¸";
        else if (["zip", "rar"].includes(ext)) fileIcon = "ğŸ—œï¸";
        else if (["pdf", "txt"].includes(ext)) fileIcon = "ğŸ“";

        item.innerHTML = `
            <div>
                <span class="file-icon">${fileIcon}</span>
                <a href="${fileInfo.url}" download style="color: #007bff; text-decoration: none;">
                    ${fileInfo.filename}
                </a>
                <span class="file-date">${fileInfo.last_modified}</span>
            </div>
            <div class="file-actions">
                <a href="${fileInfo.url}" download="${fileInfo.filename}" 
                   style="margin-right: 8px; background-color: #28a745; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 14px;">
                   ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </a>
                <button class="delete-btn" data-file="${fileInfo.filename}">å‰Šé™¤</button>
            </div>
        `;

        filesList.appendChild(item);
    });

    // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", function () {
            const fileName = this.getAttribute("data-file");
            deleteFile(fileName);
        });
    });
}
</script>

{% endblock %}
